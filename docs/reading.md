# 読み物

Garnetの技術解説文書です。

### Garnetについて

Garnetは、Rubyの処理系を持つ手続き型プログラミング言語である。

### クラス構造

Garnetクラスは、初期化時に引数に与えられたファイルを開き、字句解析を実行、解釈実行を行う。

Garnetクラスを継承したGarnetSyntaxクラスには、ガーネットの構文に関する変数やメソッドが用意されており、実行時にはトークナイザーとしてはたらく。

### Garnetクラスの変数とメソッド

### @@vars

プログラムの中で使用される変数を格納するためのハッシュ。Garnetのコードからは、`@@vars[ast[1].intern]`のように呼び出される。

また、最初からいくつかの定数が格納されていて利用可能である。以下は、そのリストである。

- `GARNET_VER` => Garnetの処理系のバージョンを示す定数。
- `DEBUG_MODE` => 1の場合、デバッグ用の出力が表示される。
- `TODAY` => 今日の日付を表す文字列。
- `SHELL` => 実行中のシェルのパスを表す文字列。

### log
DEBUG_MODEが1の場合のみ出力されるデバッグ用の標準出力を呼び出すメソッド。

### get_token

コードから1つトークンを取り出すメソッド。文字列リテラルや変数名、コメントなどを取り出し返り値として持つ。

それと同時に、後述の **@@scanner_log** 配列の末尾に現在のscannerを複製したオブジェクトを追加する。

トークンを取り出し、以下の正規表現へのマッチを試行する。

- `/\A\s*\[(.*?)[^\[|^\]]\]/` => [] で囲まれたコメントであるとき。
- `/\A\s*"(.*?)[^\\]"|""/` => ""で囲まれた文字列であるとき(バックスラッシュによるエスケープを実現するため、**「"」で始まり「\」以外の1文字＋「"」で終わる文字列**または**「""」**)。
- `/\A\s*(#{ _keywords.join('|') })/` => 後述の**GarnetSyntax::KW**に該当するトークンであるとき。
- `GarnetSyntax::VAREXP` => 変数の正規表現(後述)に該当するトークンであるとき。
- /`\A\s*\z/` => 空白のみの時。nilを返す。

### @@scanner_log

トークンの取得ごとにStringScannerインスタンスの複製の履歴を保持するための配列。

### unget_token

先読みを行ったトークンを戻すためのメソッド。**@@scanner_log**の末尾をscannerに代入し直しunget後に配列の末尾を削除することで複数回のungetを行う。

### eval

抽象構文木の構造を与えることでそれを評価するGarnetの実行器である。それぞれの構造は木構造がなくなるまで再びevalメソッドを呼ぶ再帰が発生し続ける。

ノードの種類によって以下のような処理が行われる。

- **文列ノードの場合**：AST配列のインデックス1からインデックス−1までを順番に評価する。
- **代入ノードの場合**：変数空間 **@@vars**に式の評価結果を代入する。
- **出力(print)ノードの場合**：標準出力に式の評価結果を出力する。
- **変数ノードの場合**：変数空間 **@@vars**から変数の値を取り出す。
- **文字列ノードの場合**：文字列をそのまま返す。
- **入力(input)ノードの場合**：標準入力から入力を受け取り、変数空間 **@@vars**に値を代入する。
- **加算ノードの場合**：左辺の評価結果が文字列の場合、右辺の評価結果と結合を行う。それ以外の場合、浮動小数点に変換し加算を行う。
- **減算ノードの場合**：左辺の評価結果から右辺の評価結果を減算する。
- **乗算ノードの場合**：左辺の評価結果から右辺の評価結果を乗算する。
- **除算ノードの場合**：左辺の評価結果から右辺の評価結果を除算する。
- **剰余算ノードの場合**：左辺の評価結果から右辺の評価結果を剰余算する。
- **等価演算ノードの場合**：左辺の評価結果が文字列の場合、それぞれを文字列／整数／浮動小数点への型変換を試み、いずれか1つ以上が等価であるかを返す。そうでない場合、それぞれを浮動小数点へ変換し等価演算を行う。
- **if文ノードの場合**：条件式の評価結果が**GarnetSyntax::FALSY**に含まれていなければ(＝条件式がtruthyならば)、文を実行する。

### GarnetSyntaxクラスの変数とメソッド

### KW

Garnetの文法上キーワードとなる語を格納したハッシュ。

### FALSY

Garnetは真偽値型を定義しないため、直接`true`/`false`という値を扱わない。そのため値をtruthyであるかfalsyであるかで真偽判定を行っている。

**GarnetSyntax::FALSY**は、値としてfalsyなものをすべて格納した配列である。if文の条件式などで、真偽判定を行う場合、この配列に含まれない値はすべてtruthyなものであるとして扱う。

### VAREXP

Garnetにおける変数の正規表現を表す定数。アルファベット、アンダースコア、DOLLAR SIGN、絵文字のいずれかから始まり、アルファベット、アンダースコア、DOLLAR SIGN、0〜9の数字が0文字以上続く文字列。

### sentences

> [文列] 文(文)＊

文列をトークナイズするためのメソッド。`[:block, <文>*]`という形式のノードを返す。

### sentence

> [文] ○○文|{文列}

文をトークナイズするためのメソッド。文には、代入文やその他の文、文列を一つの文として扱うための`{<文列>}`というリテラルが含まれる。

### print

> [print文] << 式

print文をトークナイズするためのメソッド。`[:print, <式>]`という形式のノードを返す。

### input

> [input文] >> 変数名

input文をトークナイズするためのメソッド。`[:input, <変数名>]`という形式のノードを返す。

### assignment

> [代入文] 変数名 <= 式

代入文をトークナイズするためのメソッド。`[:assign, <変数名>, <式>]`という形式のノードを返す。

### ifst

> [if文] 式 ?? 文

if文をトークナイズするためのメソッド。`[:ifst, <式>, <文>]`という形式のノードを返す。

### expression

> [式] 項([+|-] 項)＊

式をトークナイズするためのメソッド。termメソッドを呼び出す。

### term

> [項] 因子([*|/|%|:)]因子)＊

項をトークナイズするためのメソッド。factorメソッドを呼び出す。

### factor

> [因子] リテラル|変数|(式)|”文字列”

因子をトークナイズするためのメソッド。

